{"version":3,"file":"logger.js","sources":["../src/logger.js"],"sourcesContent":["/*\n  Logentries client that supports POSTing to an HTTP endpoint. The `write`\n  method has been modified to use a client-provided low-level `writer` function\n  to send HTTP requests (`writer` in the opts object). It must take these\n  arguments:\n    - the HTTP endpoint to which to log\n    - the HTTP request body (as a UTF-8-encoded Buffer)\n  It must write the request to the endpoint with 'Content-Type' of\n 'application/json', and resolve on response status 204, or reject.\n\n This is forked from mainline le_node. The essential modifications are in the\n `write` method, with minor modifications elsewhere, and the wholesale removal\n of functionality used to maintain the health of the (former) TCP socket.\n\n This is implemented as it's own package rather than trying to refactor the\n original `Logger` to serve both purposes to ease the integration of upstream\n updates. If you want to log to a socket, use mainline `le_node`.\n*/\nimport _ from 'lodash';\nimport semver from 'semver';\nimport os from 'os';\nimport { Writable } from 'stream';\nimport codependency from 'codependency';\nimport * as defaults from './defaults';\nimport * as levelUtil from './levels';\nimport text from './text';\nimport build from './serialize';\nimport {\n    BadOptionsError,\n    LogentriesError\n} from './error';\nimport RingBuffer from './ringbuffer';\nimport BunyanStream from './bunyanstream';\n\n// patterns\nconst tokenPattern = /[a-f\\d]{8}-([a-f\\d]{4}-){3}[a-f\\d]{12}/;\n\n// exposed Logger events\nconst errorEvent = 'error';\nconst logEvent = 'log';\nconst connectedEvent = 'connected';\nconst disconnectedEvent = 'disconnected';\nconst timeoutEvent = 'timed out';\nconst drainWritableEvent = 'drain';\nconst finishWritableEvent = 'finish';\nconst pipeWritableEvent = 'pipe';\nconst unpipeWritableEvent = 'unpipe';\nconst bufferDrainEvent = 'buffer drain';\n\n/**\n * Get console method corresponds to lvl\n *\n * @param lvl\n * @returns {*}\n */\nconst getConsoleMethod = lvl => {\n  if (lvl > 3) {\n    return 'error';\n  } else if (lvl === 3) {\n    return 'warn';\n  }\n  return 'log';\n};\n\n/**\n * Get a new prop name that does not exist in the log.\n *\n * @param log\n * @param prop\n * @returns safeProp\n */\nconst getSafeProp = (log, prop) => {\n  let safeProp = prop;\n  while (safeProp in log) {\n    safeProp = `_${safeProp}`;\n  }\n  return safeProp;\n};\n\nconst requirePeer = codependency.register(module);\n\n/**\n * Logger class that handles parsing of logs and sending logs to Logentries.\n */\nclass Logger extends Writable {\n  constructor(opts) {\n    super({\n      objectMode: true\n    });\n\n    // Sanity checks\n    if (_.isUndefined(opts)) {\n      throw new BadOptionsError(opts, text.noOptions());\n    }\n\n    if (!_.isObject(opts)) {\n      throw new BadOptionsError(opts, text.optionsNotObj(typeof opts));\n    }\n\n    if (_.isUndefined(opts.token)) {\n      throw new BadOptionsError(opts, text.noToken());\n    }\n\n    if (!_.isString(opts.token) || !tokenPattern.test(opts.token)) {\n      throw new BadOptionsError(opts, text.invalidToken(opts.token));\n    }\n\n    if (_.isUndefined(opts.writer)) {\n      throw new BadOptionsError(opts, text.noWriter());\n    }\n\n    if (!_.isFunction(opts.writer)) {\n      throw new BadOptionsError(opts, text.invalidWriter(opts.writer));\n    }\n\n    // Log method aliases\n    this.levels = levelUtil.normalize(opts);\n\n    for (const lvlName of this.levels) {\n      if (lvlName in this) {\n        throw new BadOptionsError(opts, text.levelConflict(lvlName));\n      }\n\n      Object.defineProperty(this, lvlName, {\n        enumerable: true,\n        writable: false,\n        value() {\n          this.log.apply(this, [lvlName, ...arguments]);\n        }\n      });\n    }\n\n    // boolean options\n    this.debugEnabled = opts.debug === undefined ? defaults.debug : opts.debug;\n    this.json = opts.json;\n    this.flatten = opts.flatten;\n    this.flattenArrays = 'flattenArrays' in opts ? opts.flattenArrays : opts.flatten;\n    this.console = opts.console;\n    this.withLevel = 'withLevel' in opts ? opts.withLevel : true;\n    this.withStack = opts.withStack;\n    this.withHostname = opts.withHostname || false;\n    this.timestamp = opts.timestamp || false;\n\n    // string or numeric options\n    this.bufferSize = opts.bufferSize || defaults.bufferSize;\n    this.minLevel = opts.minLevel;\n    this.replacer = opts.replacer;\n    this.token = opts.token;\n    this.endpoint = `https://webhook.logentries.com/noformat/logs/${this.token}`;\n\n    // low-level writer function\n    this.writer = opts.writer;\n\n    if (!this.debugEnabled) {\n      // if there is no debug set, empty logger should be used\n      this.debugLogger = {\n        log: () => {\n        }\n      };\n    } else {\n      this.debugLogger =\n          (opts.debugLogger && opts.debugLogger.log) ? opts.debugLogger : defaults.debugLogger;\n    }\n\n    this.ringBuffer = new RingBuffer(this.bufferSize);\n\n    // RingBuffer emits buffer shift event, meaning we are discarding some data!\n    this.ringBuffer.on('buffer shift', () => {\n      this.debugLogger.log('Buffer is full, will be shifting records until buffer is drained.');\n    });\n\n    this.on(bufferDrainEvent, () => {\n      this.debugLogger.log('RingBuffer drained.');\n      this.drained = true;\n    });\n  }\n\n  /**\n   * Override Writable _write method.\n   * Write POST one log record to the endpoint.\n   */\n  _write(ch, enc, cb) {\n    this.drained = false;\n    try {\n      const record = this.ringBuffer.read();\n      if (record) {\n        let promise = this.writer(this.endpoint, record);\n        if (this.ringBuffer.isEmpty()) {\n          // we are checking the buffer state here just after POSTing\n          // to make sure the last event is sent.\n          promise = promise\n            .then(() => {\n              process.nextTick(() => {\n                this.emit(bufferDrainEvent);\n                // this event is DEPRECATED - will be removed in next major release.\n                // new users should use 'buffer drain' event instead.\n                this.emit('connection drain');\n              });\n            });\n        }\n        promise\n          .catch(err => {\n            this.emit(errorEvent, err);\n            this.debugLogger.log(`Error: ${err}`);\n          })\n          .then(() => cb());\n      } else {\n        this.debugLogger.log('This should not happen. Read from ringBuffer returned null.');\n        cb();\n      }\n    } catch (err) {\n      this.emit(errorEvent, err);\n      this.debugLogger.log(`Error: ${err}`);\n      cb();\n    }\n  }\n\n  setDefaultEncoding() { /* no. */\n  }\n\n  /**\n   * Finalize the log and write() to Logger stream\n   * @param lvl\n   * @param log\n   */\n  log(lvl, log) {\n    let modifiedLevel = lvl;\n    let modifiedLog = log;\n    // lvl is optional\n    if (modifiedLog === undefined) {\n      modifiedLog = modifiedLevel;\n      modifiedLevel = null;\n    }\n\n    let lvlName;\n\n    if (modifiedLevel || modifiedLevel === 0) {\n      [modifiedLevel, lvlName] = this.toLevel(modifiedLevel);\n\n      // If lvl is present, it must be recognized\n      if (!modifiedLevel && modifiedLevel !== 0) {\n        this.emit(errorEvent, new LogentriesError(text.unknownLevel(modifiedLevel)));\n        return;\n      }\n\n      // If lvl is below minLevel, it is dismissed\n      if (modifiedLevel < this.minLevel) {\n        return;\n      }\n    }\n\n    // If log is an array, it is treated as a collection of log events\n    if (_.isArray(modifiedLog)) {\n      if (modifiedLog.length) {\n        for (const $modifiedLog of modifiedLog) this.log(modifiedLevel, $modifiedLog);\n      } else {\n        this.emit(errorEvent, new LogentriesError(text.noLogMessage()));\n      }\n      return;\n    }\n\n    // If log is an object, it is serialized to string and may be augmented\n    // with timestamp and level. For strings, these may be prepended.\n    if (_.isObject(modifiedLog)) {\n      let safeTime;\n      let safeLevel;\n      let safeHost;\n\n      if (this.timestamp) {\n        safeTime = getSafeProp(modifiedLog, 'time');\n        modifiedLog[safeTime] = new Date();\n      }\n\n      if (this.withLevel && lvlName) {\n        safeLevel = getSafeProp(modifiedLog, 'level');\n        modifiedLog[safeLevel] = lvlName;\n      }\n\n      if (this.withHostname) {\n        safeHost = getSafeProp(modifiedLog, 'host');\n        modifiedLog[safeHost] = os.hostname();\n      }\n\n      modifiedLog = this._serialize(modifiedLog);\n\n      if (!modifiedLog) {\n        this.emit(errorEvent, new LogentriesError(text.serializedEmpty()));\n        return;\n      }\n\n      if (this.console) {\n        console[getConsoleMethod(modifiedLevel)](JSON.parse(modifiedLog));\n      }\n\n      if (safeTime) delete modifiedLog[safeTime];\n      if (safeLevel) delete modifiedLog[safeLevel];\n      if (safeHost) delete modifiedLog[safeHost];\n    } else {\n      if (_.isEmpty(modifiedLog)) {\n        this.emit(errorEvent, new LogentriesError(text.noLogMessage()));\n        return;\n      }\n\n      modifiedLog = [modifiedLog.toString()];\n\n      if (this.withLevel && lvlName) {\n        modifiedLog.unshift(lvlName);\n      }\n\n      if (this.withHostname) {\n        modifiedLog.unshift(os.hostname());\n      }\n\n      if (this.timestamp) {\n        modifiedLog.unshift((new Date()).toISOString());\n      }\n\n      modifiedLog = modifiedLog.join(' ');\n\n      if (this.console) {\n        console[getConsoleMethod(modifiedLevel)](modifiedLog);\n      }\n    }\n\n    this.emit(logEvent, modifiedLog);\n\n    // if RingBuffer.write returns false, don't create any other write request for\n    // the writable stream to avoid memory leak this means there are already 'bufferSize'\n    // of write events in the writable stream and that's what we want.\n    if (this.ringBuffer.write(Buffer.from(modifiedLog.toString()))) {\n      this.write();\n    }\n  }\n\n  // Private methods\n  toLevel(val) {\n    let num;\n\n    if (levelUtil.isNumberValid(val)) {\n      num = parseInt(val, 10); // -0\n    } else {\n      num = this.levels.indexOf(val);\n    }\n\n    const name = this.levels[num];\n\n    return name ? [num, name] : [];\n  }\n\n  get debugEnabled() {\n    return this._debugEnabled;\n  }\n\n  set debugEnabled(val) {\n    this._debugEnabled = !!val;\n  }\n\n  get debugLogger() {\n    return this._debugLogger;\n  }\n\n  set debugLogger(func) {\n    this._debugLogger = func;\n  }\n\n  get ringBuffer() {\n    return this._ringBuffer;\n  }\n\n  set ringBuffer(obj) {\n    this._ringBuffer = obj;\n  }\n\n  get token() {\n    return this._token;\n  }\n\n  set token(val) {\n    this._token = val;\n  }\n\n  get bufferSize() {\n    return this._bufferSize;\n  }\n\n  set bufferSize(val) {\n    this._bufferSize = val;\n  }\n\n  get console() {\n    return this._console;\n  }\n\n  set console(val) {\n    this._console = !!val;\n  }\n\n  get serialize() {\n    return this._serialize;\n  }\n\n  set serialize(func) {\n    this._serialize = func;\n  }\n\n  get flatten() {\n    return this._flatten;\n  }\n\n  set flatten(val) {\n    this._flatten = !!val;\n    this.serialize = build(this);\n  }\n\n  get flattenArrays() {\n    return this._flattenArrays;\n  }\n\n  set flattenArrays(val) {\n    this._flattenArrays = !!val;\n    this.serialize = build(this);\n  }\n\n  get json() {\n    return this._json;\n  }\n\n  set json(val) {\n    this._json = val;\n  }\n\n  get minLevel() {\n    return this._minLevel;\n  }\n\n  set minLevel(val) {\n    const [num] = this.toLevel(val);\n\n    this._minLevel = _.isNumber(num) ? num : 0;\n  }\n\n  get replacer() {\n    return this._replacer;\n  }\n\n  set replacer(val) {\n    this._replacer = _.isFunction(val) ? val : undefined;\n    this.serialize = build(this);\n  }\n\n  get timestamp() {\n    return this._timestamp;\n  }\n\n  set timestamp(val) {\n    this._timestamp = !!val;\n  }\n\n  get withHostname() {\n    return this._withHostname;\n  }\n\n  set withHostname(val) {\n    this._withHostname = val;\n  }\n\n  get withLevel() {\n    return this._withLevel;\n  }\n\n  set withLevel(val) {\n    this._withLevel = !!val;\n  }\n\n  get withStack() {\n    return this._withStack;\n  }\n\n  set withStack(val) {\n    this._withStack = !!val;\n    this.serialize = build(this);\n  }\n\n  get levels() {\n    return this._levels && this._levels.slice();\n  }\n\n  set levels(val) {\n    this._levels = val;\n  }\n\n  // Deprecated (to support migrants from le_node)\n  level(name) {\n    console.warn(text.deprecatedLevelMethod());\n    if (~this.levels.indexOf(name)) this.minLevel = name;\n  }\n\n  // static methods\n  static winston() {\n    console.warn(text.deprecatedWinstonMethod());\n  }\n\n  /**\n   * Prepare the winston transport\n   * @param winston\n   */\n  static provisionWinston(winston) {\n    if (winston.transports.Logentries) return;\n\n    const Transport = winston.Transport;\n\n    class LogentriesTransport extends Transport {\n      constructor(opts) {\n        super(opts);\n        this.json = opts.json;\n        this.name = 'logentries';\n\n        const transportOpts = _.clone(opts || {});\n\n        transportOpts.minLevel =\n            transportOpts.minLevel || transportOpts.level || this.tempLevel || 0;\n\n        transportOpts.levels = transportOpts.levels || winston.levels;\n        if (semver.satisfies(winston.version, '>=2.0.0')) {\n          // Winston and Logengries levels are reversed\n          // ('error' level is 0 for Winston and 5 for Logentries)\n          // If the user provides custom levels we assue they are\n          // using winston standard\n          const levels = transportOpts.levels;\n          const values = _.values(levels).reverse();\n          transportOpts.levels = {};\n          _.keys(levels).forEach((k, i) => {\n            transportOpts.levels[k] = values[i];\n          });\n        }\n\n        this.tempLevel = null;\n        this.logger = new Logger(transportOpts);\n        this.logger.on('error', err => this.emit(err));\n      }\n\n      log(lvl, msg, meta, cb) {\n        if (this.json) {\n          const message = {\n            message: msg\n          };\n          if (!_.isEmpty(meta)) {\n            if (_.isObject(meta)) {\n              _.defaults(message, meta);\n            } else {\n              message.meta = meta;\n            }\n          }\n\n          this.logger.log(lvl, message);\n        } else {\n          let message = msg;\n          if (!_.isEmpty(meta) || _.isError(meta)) {\n            if (_.isString(message)) {\n              message += ` ${this.logger.serialize(meta)}`;\n            } else if (_.isObject(message)) {\n              message[getSafeProp(message, 'meta')] = meta;\n            }\n          }\n\n          this.logger.log(lvl, message);\n        }\n\n        setImmediate(cb.bind(null, null, true));\n      }\n\n      get tempLevel() {\n        return this._tempLevel;\n      }\n\n      set tempLevel(val) {\n        this._tempLevel = val;\n      }\n\n      get logger() {\n        return this._logger;\n      }\n\n      set logger(obj) {\n        this._logger = obj;\n      }\n\n      get level() {\n        const [, lvlName] =\n            this.logger.toLevel(this.logger.minLevel);\n        return lvlName;\n      }\n\n      set level(val) {\n        if (!this.logger) {\n          this.tempLevel = val;\n        } else {\n          this.logger.minLevel = val;\n        }\n      }\n\n      get levels() {\n        return this.logger.levels.reduce((acc, lvlName, lvlNum) => {\n          const newAcc = acc;\n          newAcc[lvlName] = lvlNum;\n          return newAcc;\n        }, {});\n      }\n    }\n\n    /* eslint no-param-reassign: [\"error\", { \"props\": false }] */\n    winston.transports.Logentries = LogentriesTransport;\n  }\n\n  /**\n   * Prepare a BunyanStream.\n   * @param opts\n   * @returns {{level: *, name: string, stream: BunyanStream, type: string}}\n   */\n  static bunyanStream(opts) {\n    const stream = new BunyanStream(opts);\n    const [, level] = stream.logger.toLevel(stream.logger.minLevel);\n    const type = 'raw';\n    const name = 'logentries';\n\n    // Defer to Bunyanâ€™s handling of minLevel\n    stream.logger.minLevel = 0;\n\n    return { level, name, stream, type };\n  }\n}\n\n// provision winston\nconst winston = requirePeer('winston', { optional: true });\n\nif (winston) Logger.provisionWinston(winston);\n\n// Provision too the winston static versions for testing/development purposes\nconst winston1 = requirePeer('winston1', { optional: true });\nconst winston2 = requirePeer('winston2x', { optional: true });\n\nif (winston1) Logger.provisionWinston(winston1);\nif (winston2) Logger.provisionWinston(winston2);\n\nexport {\n    Logger as default,\n    errorEvent,\n    logEvent,\n    connectedEvent,\n    disconnectedEvent,\n    timeoutEvent,\n    drainWritableEvent,\n    finishWritableEvent,\n    pipeWritableEvent,\n    unpipeWritableEvent,\n    bufferDrainEvent\n};\n"],"names":["bind","isError","message","meta","msg","logger","i","k","forEach","keys","optional","Writable","requirePeer","BunyanStream","type","getSafeProp","stream","_withStack","newAcc","Transport","num","reduce","lvlNum","withStack","catch","acc","codependency","_levels","slice","winston","deprecatedWinstonMethod","_logger","isFunction","_tempLevel","writer","join","LogentriesTransport","_debugEnabled","on","bufferDrainEvent","pipeWritableEvent","unpipeWritableEvent","module","isUndefined","_token","isObject","cb","arguments","isEmpty","process","endpoint","transports","values","tempLevel","reverse","satisfies","version","semver","transportOpts","clone","level","Logentries","undefined","isNumberValid","objectMode","_withLevel","_timestamp","_withHostname","_replacer","isNumber","_minLevel","_json","_flattenArrays","test","apply","_flatten","serialize","write","_console","_bufferSize","obj","safeHost","warn","_ringBuffer","func","_debugLogger","deprecatedLevelMethod","name","indexOf","val","parseInt","from","Buffer","toString","minLevel","unshift","toISOString","emit","_serialize","defaults","finishWritableEvent","nextTick","parse","serializedEmpty","noLogMessage","JSON","console","safeTime","safeLevel","flattenArrays","json","err","unknownLevel","$modifiedLog","length","isArray","os","hostname","Date","LogentriesError","toLevel","modifiedLog","modifiedLevel","ch","replacer","lvl","levelUtil","promise","record","then","read","enc","RingBuffer","drained","debugLogger","log","ringBuffer","bufferSize","opts","debugEnabled","token","timestamp","withHostname","withLevel","flatten","debug","levels","lvlName","value","writable","enumerable","BadOptionsError","text","levelConflict","normalize","invalidWriter","_","noWriter","invalidToken","isString","tokenPattern","noToken","optionsNotObj","noOptions","Logger","register","safeProp","prop","getConsoleMethod","drainWritableEvent","timeoutEvent","disconnectedEvent","connectedEvent","logEvent","errorEvent"],"mappings":"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"}